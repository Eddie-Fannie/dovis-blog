# 模板编译原理
在vue中创建`Html`并不是只有模板这一种途径，我们既可以手动写渲染函数来创建，也可以使用`JSX`来创建。渲染函数是创建`HTML`最原始的方法。模板最终会通过编译转换成渲染函数，渲染函数执行后，会得到一份`vnode`用于虚拟DOM渲染。所以模板编译其实是配合虚拟DOM进行渲染。

渲染函数的作用是每次执行它，它就会使用当前最新的状态生成一份新的`vnode`，然后使用这个`vnode`进行渲染。

## 将模板编译成渲染函数
> 先将模板解析成`AST`（抽象语法树），然后使用抽象语法树生成渲染函数。

::: tip
由于静态节点不需要总是重新渲染，所以生成`AST`之后，生成渲染函数之前这个阶段，需要做一个操作，那就是遍历一遍抽象语法树，给所有静态节点做一个标记，这样在虚拟`DOM`
中更新节点时，如果发现这个节点有标记就不会重新渲染它。
:::

所以模板编译大体分为三部分：
- 将模板解析为`AST`--解析器
- 遍历抽象语法树标记静态节点--优化器
- 使用抽象语法树生成渲染函数--代码生成器

## 解析器
在解析器内部分成很多小解析器：包括过滤器解析器，文本解析器和HTML解析器，然后通过一条主线将这些解析器组装在一起。
- 过滤器解析器
> 用来解析过滤器的

- 文本解析器
> 用来解析带变量的文本

- `HTML`解析器
> 解析模板，每当解析到HTML标签的开始位置，结束位置，文本或者注释，都会触发钩子函数，然后将相关信息通过参数传递出来。

::: tip
主线上做的事情就是监听HTML解析器。每当触发钩子函数时，就生成一个对应的抽象语法树节点。生成抽象语法树前，会根据类型使用不同的方式生成不同抽象语法树。例如，如果是文本节点，就生成文本类型的`AST`。当解析器不再触发钩子函数时，就说明所有模板都解析完毕，所有类型的节点都在钩子函数中构建完成，即`AST`构建完成。
:::

## 优化器
优化器的目标遍历`AST`，检测出所有静态子树（永远都不会发生变化的`DOM`节点）并打上标记。当`AST`中静态子树被打上标记后，每次重新渲染时就不需要为打上标记的静态节点创建新的虚拟节点，而是直接克隆已经存在的虚拟节点。

## 代码生成器
代码生成器是模板函数编译最后一步，作用是将`AST`转换成渲染函数中的内容，这个内容可以称为代码字符串。
```js
<p title='Berwin' @click='c'>1</p>

// 生成的代码字符串
`with(this){return _c('p',{attrs: {"titile":"Berwin"}, on: {"clcik":c}}, [_v("1")]}`

//格式化后
with(this) {
    return _c(
        'p',
        {
            attrs:{"title":"Berwin"},
            on:{"click":c}
        },
        [_v("1")]
    )
}
```

::: tip
渲染函数之所以可以生成`vnode`，是因为代码字符串中会有很多函数调用（如`_c/_v`），这些函数是虚拟DOM提供创建`vnode`的方法。vnode有很多种类型，不同的类型对应不同的创建方法，所以代码字符串中的`_c/_v`其实都是创建vnode的方法，只是创建的`vnode`的类型不同。例如，`_c`可以创建元素类型的`vnode`，而`_v`可以创建文本类型的`vnode`
:::