# æ‰‹åŠ¨å®ç°ä¸€ä¸ªæ·±æ‹·è´
ç®€å•é€’å½’ï¼Œæ·±å±‚éå†å¯¹è±¡
```js
function deepClone (obj) {
    let newObj = {}
    for(let item in obj) {
        if(typeof obj[item] !== 'object') {
            newObj[item] = obj[item]
        } else {
            newObj[item] = deepClone(obj[item])
        }
    }
    return newObj
}
var obj1 = {
    name: 'linjiaheng',
    age: 23,
    partner: ['laihengcong', 'quanzhiyuan', 'penghaohao']
}
var obj2 = deepClone(obj1)
obj2.name = 'xielin'
obj2.age = 24
obj2.partner[0] = 'xiaoxiao'
console.log(obj2)
console.log(obj1)
```
![img](/dovis-blog/other/29.png)

## å­˜åœ¨çš„é—®é¢˜
1. ä¼ å…¥çš„å¯¹è±¡å‚æ•°æ²¡æœ‰æ ¡éªŒï¼Œå¯èƒ½æ˜¯`null/Date/RegExp/Array`
```js
// åˆ¤æ–­ä¼ å…¥çš„å‚æ•°
function deepClone(obj) {
    if(!isObject(obj)) return obj;
    if(obj == null) return null;
    if(obj instanceof Date) return new Date(obj)
    if(obj instanceof RegExp) return new RegExp(obj);
    if(Object.prototype.toString.call(obj) === '[object Array]') {
        // å¤„ç†æ•°ç»„
    }
}
```

2. åˆ¤æ–­å¯¹è±¡
```js
function isObject(x) {
    return Object.prototype.toString.call(x) === '[object Object]'
}
```

3. è‹¥ä¸ºæ•°ç»„ï¼Œæˆ–è€…ä¸º`Set Map weakSet weakMap`
```js
// è€ƒè™‘æ•°ç»„å…¼å®¹
var target = Array.isArray(obj) ? [] : {}
```

4. è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜
> æ‰€è°“çš„å¾ªç¯æ£€æµ‹éå¸¸ç®€å•ï¼Œæˆ‘ä»¬è®¾ç½®ä¸€ä¸ªæ•°ç»„æˆ–è€…å“ˆå¸Œè¡¨ç”¨æ¥å­˜å‚¨å·²ç»æ‹·è´è¿‡çš„å¯¹è±¡ï¼Œæ£€æµ‹å½“å‰å¯¹è±¡æ˜¯å¦å·²ç»å­˜åœ¨äºå“ˆå¸Œè¡¨ä¸­ï¼Œå¦‚æœæœ‰ï¼Œå–å‡ºè¯¥å€¼ï¼Œç„¶åè¿”å›ã€‚

```js
function deepClone(obj, map=new Map()) {
    if(!isObject(obj)) return obj;
    
    // å¾ªç¯æ£€æµ‹ï¼Œå¦‚æœå­˜åœ¨ç›´æ¥è¿”å›è¯¥å€¼
    if(map.has(obj)) return map.get(obj)

    // åˆ¤æ–­æ•°ç»„
    var target = Array.isArray(obj) ? [] : {}

    map.set(obj, target)

    // éå†æ‹·è´
    for(let item in obj) {
        if(obj.hasOwnProperty(key)) {
            if(isObject(obj[key])) {
                target[key] = deepClone(obj[key], map)
            } else {
                target[key] = obj[key]
            }
        }
    }
    return target
}
```

5. é€’å½’å®¹æ˜“çˆ†æ ˆï¼ˆå±‚æ¬¡å¾ˆæ·±çš„æ—¶å€™ï¼‰
ä¹‹å‰çš„æ–‡ç« [ç ´è§£é€’å½’çˆ†æ ˆ](/basis/JavaScript/å¯¹è±¡æ·±æµ…æ‹·è´.html#æ·±æ‹·è´å®ç°æ–¹å¼)

## æŒ‰ç…§æ•°æ®ç±»å‹å®ç°ä¸€ä¸ªæ·±æ‹·è´
```js
// åˆ¤æ–­ç±»å‹
function getType (target) {
    return Object.prototype.toString.call(target).slice(8, -1)
}
// åˆ¤æ–­æ˜¯å¦æ˜¯åŸå§‹ç±»å‹ç±»å‹.
// å¯¹åº”å¯å¼•ç”¨çš„æ•°æ®ç±»å‹ï¼Œéœ€è¦é€’å½’éå†ï¼›å¯¹åº”ä¸å¯å¼•ç”¨çš„æ•°æ®ç±»å‹ï¼Œç›´æ¥å¤åˆ¶å³å¯
function isReferenceType (target) {
    let type = typeof target
    return (target !== null && (type === 'object' || type === 'function'))
}
// è·å–åŸå‹ä¸Šçš„æ–¹æ³•
function getInit (target) {
    let ClassNames = target.constructor
    return new ClassNames()
}
// å¼•ç”¨ç±»å‹
const mapTag = 'Map'
const setTag = 'Set'
const arrayTag = 'Array'
const objectTag = 'Object'

// ä¸å¯å¼•ç”¨ç±»å‹
const boolTag = 'Boolean'
const dateTag = 'Date'
const errorTag = 'Error'
const numberTag = 'Number'
const regexpTag = 'RegExp'
const stringTag = 'String'
const symbolTag = 'Symbol'
const bufferTag = 'Uint8Array'

let deepTag = [mapTag, setTag, arrayTag, objectTag]
function deepClone(target,map=new Map()) {
    let type = getType(target)
    let isOriginType = isReferenceType(target) 
    if(!isOriginType) {return target} // å¯¹äºä¸å¯å¼•ç”¨çš„æ•°æ®ç±»å‹ï¼Œç›´æ¥å¤åˆ¶å³å¯
    let cloneTarget
    if(deepTag.includes(type)){
        cloneTarget = getInit(target)
    }

    // é˜²æ­¢å¾ªç¯å¼•ç”¨
    if(map.get(target)) {
        return map.get(target)
    }
    map.set(target,cloneTarget)

    // å¦‚æœæ˜¯mapTagç±»å‹
    if(type === mapTag) {
        target.forEach((v,key) => {
            cloneTarget.set(key,deepClone(v,map))
        })
        return cloneTarget
    }
    if(type === setTag) {
        target.forEach((v) => {
            cloneTarget.add(deepClone(v,map))
        })
        return cloneTarget
    }
    if (type === arrayTag) {
        target.forEach((v, i) => {
          cloneTarget[i] = deepClone(v, map)
        })
        return cloneTarget
    }
     // å¦‚æœæ˜¯ objectTag ç±»å‹
    if (type === objectTag) {
        let array = Object.keys(target)
        array.forEach((i, v) => {
            cloneTarget[i] = deepClone(target[i], map)
        })
        return cloneTarget
    }
}

const map = new Map()
map.set('key', 'value')
map.set('name', 'kaka')

const set = new Set()
set.add('11').add('12')
console.log(JSON.stringify(map))
console.log(JSON.stringify(new Set([1,2])))

const target = {
  field1: 1,
  field2: undefined,
  field3: {
    child: 'child'
  },
  field4: [
    2, 8
  ],
  empty: null,
  map,
  set,
  test: {
      name: 'linjiaheng',
      skill: ['js','css']
  }
}
target.target = target
const target1 = deepClone(target)
target.test.name = 'è°¢ç³'
console.log('ğŸ', target)
console.log('ğŸŒ', target1)
```