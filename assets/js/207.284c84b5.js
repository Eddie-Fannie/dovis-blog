(window.webpackJsonp=window.webpackJsonp||[]).push([[207],{478:function(s,t,a){"use strict";a.r(t);var e=a(10),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"webpack的webpack-dev-server运行原理分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#webpack的webpack-dev-server运行原理分析"}},[s._v("#")]),s._v(" Webpack的webpack-dev-server运行原理分析")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://mp.weixin.qq.com/s/p1RJDpoKdTYph_IKvbL43A",target:"_blank",rel:"noopener noreferrer"}},[s._v("文章来源WecTeam"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("code",[s._v("webpack-dev-server")]),s._v(" 可以看作一个服务者，它的主要工作就是接收浏览器的请求，然后将资源返回。当服务启动时，它会先让 "),t("code",[s._v("Webpack")]),s._v(" 进行模块打包并将资源准备好。当 "),t("code",[s._v("webpack-dev-server")]),s._v(" 接收到浏览器的资源请求时，它会首先进行 "),t("code",[s._v("URL")]),s._v(" 地址校验。如果该地址是资源服务地址，"),t("code",[s._v("webpack-dev-server")]),s._v(" 就会从 "),t("code",[s._v("Webpack")]),s._v(" 的打包结果中寻找该资源并返回给浏览器。反之，如果请求地址不属于资源服务地址，则直接读取硬盘中的源文件并将其返回。")]),s._v(" "),t("p",[s._v("综上我们可以总结出 "),t("code",[s._v("webpack-dev-server")]),s._v(" 的两大职能。")]),s._v(" "),t("ul",[t("li",[s._v("令 "),t("code",[s._v("Webpack")]),s._v(" 进行模块打包，并处理打包结果的资源请求。")]),s._v(" "),t("li",[s._v("作为普通的 "),t("code",[s._v("Web Server")]),s._v("，处理静态资源文件请求。")])]),s._v(" "),t("blockquote",[t("p",[t("code",[s._v("webpack")]),s._v(" 将我们的项目源代码进行编译打包成可分发上线的静态资源，在开发阶段我们想要预览页面效果的话就需要启动一个服务器伺服 "),t("code",[s._v("webpack")]),s._v(" 编译出来的静态资源。"),t("code",[s._v("webpack-dev-server")]),s._v("就是用来启动 "),t("code",[s._v("webpack")]),s._v(" 编译、伺服这些静态资源。除此之外，它还默认提供了"),t("code",[s._v("liveReload")]),s._v("的功能，就是在一次 "),t("code",[s._v("webpack")]),s._v(" 编译完成后浏览器端就能自动刷新页面读取最新的编译后资源。为了提升开发体验和效率，它还提供了 "),t("code",[s._v("hot")]),s._v(" 选项开启 "),t("code",[s._v("hotReload")]),s._v("，相对于 "),t("code",[s._v("liveReload")]),s._v(", "),t("code",[s._v("hotReload")]),s._v(" 不刷新整个页面，只更新被更改过的模块。")])]),s._v(" "),t("h2",{attrs:{id:"入口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#入口"}},[s._v("#")]),s._v(" 入口")]),s._v(" "),t("p",[s._v("作为命令行启动，"),t("code",[s._v("webpack-dev-server/bin/webpack-dev-server.js")]),s._v("就是整个命令行的入口。")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// webpack-dev-server/bin/webpack-dev-server.js")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("startDevServer")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" options")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" compiler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2. 调用webpack函数返回的是 webpack compiler 实例")]),s._v("\n    compiler "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("webpack")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3. 实例化 webpack-dev-server")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Server")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("compiler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" options"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("options"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("socket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4. 调用 server 实例的 listen 方法")]),s._v("\n    server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("listen")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("options"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("port"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" options"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("err")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1. 对参数进行处理后启动")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("processOptions")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" options")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("startDevServer")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" options"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[t("code",[s._v("webpack-dev-server")]),s._v(" 作为命令行启动，首先是调用了 "),t("code",[s._v("webpack-cli")]),s._v(" 模块下的两个文件，分别配置了命令行提示选项、和从命令行和配置文件收集了 "),t("code",[s._v("webpack")]),s._v(" 的 "),t("code",[s._v("config")]),s._v("，这样复用了"),t("code",[s._v("webpack-cli")]),s._v(" 的代码，保持行为一致，上面贴出来的代码省略了这部分代码，有兴趣的可以自己翻阅源码。")]),s._v(" "),t("p",[s._v("之后调用 "),t("code",[s._v("processOptions")]),s._v(" 对收集的参数进行一些默认处理后得到需要传给 "),t("code",[s._v("webpack")]),s._v(" 的 "),t("code",[s._v("config")]),s._v(" 和需要传给 "),t("code",[s._v("webpack-dev-server")]),s._v(" 的 "),t("code",[s._v("options")]),s._v("。传入这两个配置参数调用 "),t("code",[s._v("startDevServer")]),s._v("，"),t("code",[s._v("startDevServer")]),s._v(" 这个函数主要是先调用 "),t("code",[s._v("webpack")]),s._v(" 函数实例化了 "),t("code",[s._v("compiler")]),s._v("，注意这里没有给 "),t("code",[s._v("webpack")]),s._v(" 函数传入回调函数，根据 "),t("code",[s._v("webpack")]),s._v(" 源码实现，不传入回调函数就不会直接运行 "),t("code",[s._v("webpack")]),s._v(" 而是返回 "),t("code",[s._v("webpack compiler")]),s._v(" 的实例，供调用方自行启动 "),t("code",[s._v("webpack")]),s._v(" 运行。拿到 "),t("code",[s._v("webpack compiler")]),s._v(" 实例和先前的 "),t("code",[s._v("webpack-dev-server")]),s._v(" 的 "),t("code",[s._v("options")]),s._v(" 就去实例化 "),t("code",[s._v("Server")]),s._v("，这个 "),t("code",[s._v("Server")]),s._v(" 类就是实现"),t("code",[s._v("webpack-dev-server")]),s._v(" 的核心逻辑。")]),s._v(" "),t("p",[s._v("最后调用 "),t("code",[s._v("Server")]),s._v(" 类的 "),t("code",[s._v("listen")]),s._v(" 方法，就正式开启监听请求，"),t("code",[s._v("listen")]),s._v(" 方法后面会再解析具体逻辑。这就是"),t("code",[s._v("webpack-dev-server")]),s._v("大致的启动过程，后面来看下 "),t("code",[s._v("Server")]),s._v(" 类具体做了什么。")])]),s._v(" "),t("blockquote",[t("p",[s._v("网页和"),t("code",[s._v("webpack-dev-server")]),s._v("是通过"),t("code",[s._v("websocket")]),s._v("协议互联的。当监听到文件变化的时候，会通过"),t("code",[s._v("websocket")]),s._v("通知网页调用"),t("code",[s._v("reload")]),s._v("接口刷新页面。")])])])}),[],!1,null,null,null);t.default=n.exports}}]);